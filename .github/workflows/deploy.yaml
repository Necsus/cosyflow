name: Deploy cozyflow namespace

on:
  push:
    branches: ["recette", "production"]
  workflow_dispatch:

concurrency:
  group: deploy-cozyflow-namespace
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      KUBECONFIG: ${{ runner.temp }}/kubeconfig
      REGISTRY: registry.necsus.dev
      IMAGE_TAG: ${{ github.sha }}
      POSTGRES_HOST: ${{ secrets.POSTGRES_HOST || 'postgres.database.svc.cluster.local' }}
      POSTGRES_PORT: ${{ secrets.POSTGRES_PORT || '5432' }}
      VITE_API_URL: https://cfapi.necsus.dev
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Connect Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}

      - name: Write kubeconfig
        run: echo "${KUBECONFIG_B64}" | base64 -d > "$KUBECONFIG"
        env:
          KUBECONFIG_B64: ${{ secrets.KUBECONFIG }}

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "v1.30.0"

      - name: Verify cluster access
        run: kubectl get nodes -o wide

      - name: Build and push backend image
        uses: docker/build-push-action@v6
        with:
          context: backend
          file: backend/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/cozyflow/backend:${{ env.IMAGE_TAG }}
            ${{ env.REGISTRY }}/cozyflow/backend:latest

      - name: Build and push frontend image
        uses: docker/build-push-action@v6
        with:
          context: frontend
          file: frontend/Dockerfile
          push: true
          build-args: |
            VITE_API_URL=${{ env.VITE_API_URL }}
          tags: |
            ${{ env.REGISTRY }}/cozyflow/frontend:${{ env.IMAGE_TAG }}
            ${{ env.REGISTRY }}/cozyflow/frontend:latest

      - name: Apply cozyflow namespace
        run: kubectl apply -f k8s/cozyflow/namespace.yaml

      - name: Create/Update registry pull secret
        run: |
          kubectl -n cozyflow create secret docker-registry registry-auth \
            --docker-server="${REGISTRY}" \
            --docker-username="${REGISTRY_USERNAME}" \
            --docker-password="${REGISTRY_PASSWORD}" \
            --docker-email="devnull@cozyflow.local" \
            --dry-run=client -o yaml | kubectl apply -f -
        env:
          REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
          REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Create/Update cozyflow Postgres secret
        run: |
          kubectl -n cozyflow create secret generic cozyflow-postgres \
            --from-literal=POSTGRES_HOST="${POSTGRES_HOST}" \
            --from-literal=POSTGRES_PORT="${POSTGRES_PORT}" \
            --from-literal=POSTGRES_DB="${POSTGRES_DB}" \
            --from-literal=POSTGRES_USER="${POSTGRES_USER}" \
            --from-literal=POSTGRES_PASSWORD="${POSTGRES_PASSWORD}" \
            --from-literal=DATABASE_URL="postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}" \
            --from-literal=SECRET_KEY="${SECRET_KEY}" \
            --from-literal=ENVIRONMENT="production" \
            --dry-run=client -o yaml | kubectl apply -f -
        env:
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}

      - name: Apply gateway and certificate
        run: kubectl apply -f k8s/cozyflow/gateway.yaml

      - name: Apply routes, policies, deployments and services
        run: |
          kubectl apply -f k8s/cozyflow/routes.yaml \
            -f k8s/cozyflow/networkpolicies.yaml \
            -f k8s/cozyflow/deployments.yaml

      - name: Update images to current tag
        run: |
          kubectl -n cozyflow set image deployment/cozyflow-api cozyflow-api=${REGISTRY}/cozyflow/backend:${IMAGE_TAG}
          kubectl -n cozyflow set image deployment/cozyflow-frontend cozyflow-frontend=${REGISTRY}/cozyflow/frontend:${IMAGE_TAG}

      - name: Wait for rollout
        run: |
          kubectl -n cozyflow rollout status deployment/cozyflow-api --timeout=180s
          kubectl -n cozyflow rollout status deployment/cozyflow-frontend --timeout=180s

      - name: Run database bootstrap job
        run: |
          kubectl -n cozyflow delete job cozyflow-db-init --ignore-not-found
          kubectl apply -f k8s/cozyflow/db-init-job.yaml
          kubectl -n cozyflow wait --for=condition=complete job/cozyflow-db-init --timeout=180s
